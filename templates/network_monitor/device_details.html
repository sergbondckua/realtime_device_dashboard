{% extends "network_monitor/base.html" %}

{% block title %}{{ device_name }} - Деталі пристрою{% endblock %}

{% block content %}
  <div class="header">
    <h1>
      <a href="/" class="nav-link"><i class="fas fa-arrow-left"></i> Повернутися</a>
      <i class="fas fa-satellite-dish"></i> {{ device_name }}
    </h1>
    <div class="status-bar">
      <div class="status-item" id="device-status-container">
        <span class="status-icon {{ 'online' if device_status else 'offline' }}">
            <i class="fas {{ 'fa-circle-check' if device_status else 'fa-circle-xmark' }}"></i>
        </span>
        <span id="device-status-text">{{ 'ONLINE' if device_status else 'OFFLINE' }}</span>
      </div>
      <div class="status-item">
        <span>IP: {{ device_ip }}</span>
      </div>
    </div>
  </div>

  <div id="loading" class="loading" style="display: none;">
    <div class="spinner"></div>
    <div>Оновлення даних...</div>
  </div>

  <div id="device-details-content">
    {% if device_status and system_info %}
      <div class="info-card">
        <h2><i class="fas fa-chart-bar"></i> Системна інформація</h2>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Модель</div>
            <div class="info-value" id="system-model">{{ system_info.model or 'N/A' }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Ім'я</div>
            <div class="info-value" id="system-name">{{ system_info.system_name or 'N/A' }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">MAC</div>
            <div class="info-value" id="mac-address">{{ system_info.mac_address or 'N/A' }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Час роботи</div>
            <div class="info-value" id="uptime">{{ system_info.uptime or 'N/A' }}</div>
          </div>
        </div>
      </div>
    {% endif %}

    {% if device_status and interfaces %}
      <div class="info-card">
        <h2><i class="fas fa-plug"></i> Інтерфейси</h2>

        <!-- Фільтр портів -->
        <div class="port-filter">
          <button class="filter-btn active" data-filter="all">Усі порти</button>
          <button class="filter-btn" data-filter="active">Активні</button>
          <button class="filter-btn" data-filter="inactive">Неактивні</button>
        </div>

        <div id="interfaces-list">
          {% for interface_id, interface in interfaces.items() %}
            {% set is_active = interface.admin_status == 1 and interface.oper_status == 1 %}
            <div class="interface-row {{ 'active-port' if is_active else 'inactive-port' }}">
              <div class="interface-name">
                <span class="port-index">{{ interface.index }}</span>
                {{ interface.name }}
              </div>
              <div class="interface-details">
                <span>{{ interface.alias or '' }}</span>
                <span class="speed"><i
                    class="fas fa-gauge-high"></i> {{ (interface.speed / 1000000)|int if interface.speed else 0 }} Mbps</span>
              </div>
              <div class="interface-status">
                <span
                    class="status-tag {{ 'status-up' if interface.admin_status == 1 else 'status-down' }}">Admin: {{ 'UP' if interface.admin_status == 1 else 'DOWN' }}</span>
                <span
                    class="status-tag {{ 'status-up' if interface.oper_status == 1 else 'status-down' }}">Port: {{ 'UP' if interface.oper_status == 1 else 'DOWN' }}</span>
              </div>
              <div class="interface-traffic">
                <div><i class="fas fa-arrow-down"></i> {{ "%.2f"|format((interface.in_octets or 0) / 1024 / 1024) }} MB
                </div>
                <div><i class="fas fa-arrow-up"></i> {{ "%.2f"|format((interface.out_octets or 0) / 1024 / 1024) }} MB
                </div>
              </div>
              {% if interface.in_errors or interface.out_errors %}
                <div class="interface-errors">
                  <i class="fas fa-triangle-exclamation"></i> {{ interface.in_errors or 0 }}/{{ interface.out_errors or 0 }}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <div class="info-card empty-state">
        <h2><i class="fas fa-triangle-exclamation"></i> Дані недоступні</h2>
        <p>Пристрій офлайн або не вдалося отримати інформацію.</p>
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block page_scripts %}
  <script>
      let currentFilter = 'all'; // Поточний вибраний фільтр

      function startAutoRefresh() {
          fetchData();
          refreshInterval = setInterval(fetchData, 10000); // Оновлення кожні 10 сек
      }

      function fetchData() {
          document.getElementById('loading').style.display = 'flex';
          fetch(`/api/device/{{ device_ip }}`)
              .then(response => {
                  if (!response.ok) {
                      throw new Error('Network response was not ok');
                  }
                  return response.json();
              })
              .then(data => {
                  // Перемальовуємо весь блок з даними
                  document.getElementById('device-details-content').innerHTML = generateDeviceContent(data);
                  // Оновлюємо статус у шапці
                  updateHeaderStatus(data.device_status);
                  // Налаштовуємо фільтри після оновлення
                  setupPortFilters();
                  // Застосовуємо поточний фільтр
                  filterPorts(currentFilter);
              })
              .catch(error => {
                  console.error('Помилка завантаження даних пристрою:', error);
                  document.getElementById('device-details-content').innerHTML = `
                <div class="info-card empty-state">
                    <h2><i class="fas fa-triangle-exclamation"></i> Помилка завантаження</h2>
                    <p>Не вдалося отримати дані. Пристрій може бути недоступний.</p>
                </div>`;
                  updateHeaderStatus(false);
              })
              .finally(() => {
                  document.getElementById('loading').style.display = 'none';
              });
      }

      function updateHeaderStatus(isOnline) {
          const container = document.getElementById('device-status-container');
          const text = document.getElementById('device-status-text');
          const iconClass = isOnline ? 'fa-circle-check' : 'fa-circle-xmark';
          const statusClass = isOnline ? 'online' : 'offline';

          container.className = `status-item`; // Скидаємо класи
          text.textContent = isOnline ? 'ONLINE' : 'OFFLINE';
          container.innerHTML = `
        <span class="status-icon ${statusClass}">
            <i class="fas ${iconClass}"></i>
        </span>
        <span id="device-status-text">${isOnline ? 'ONLINE' : 'OFFLINE'}</span>`;
      }

      // Функція для фільтрації портів
      function filterPorts(filterType) {
          currentFilter = filterType;
          const allRows = document.querySelectorAll('.interface-row');

          allRows.forEach(row => {
              switch (filterType) {
                  case 'all':
                      row.style.display = '';
                      break;
                  case 'active':
                      if (row.classList.contains('active-port')) {
                          row.style.display = '';
                      } else {
                          row.style.display = 'none';
                      }
                      break;
                  case 'inactive':
                      if (row.classList.contains('inactive-port')) {
                          row.style.display = '';
                      } else {
                          row.style.display = 'none';
                      }
                      break;
              }
          });
      }

      // Налаштування обробників подій для фільтрів
      function setupPortFilters() {
          document.querySelectorAll('.filter-btn').forEach(btn => {
              btn.addEventListener('click', function () {
                  // Видаляємо активний клас у всіх кнопок
                  document.querySelectorAll('.filter-btn').forEach(b => {
                      b.classList.remove('active');
                  });

                  // Додаємо активний клас до поточної кнопки
                  this.classList.add('active');

                  // Застосовуємо фільтр
                  filterPorts(this.dataset.filter);
              });
          });
      }

      // Функція для генерації HTML контенту на основі JSON
      function generateDeviceContent(data) {
          if (!data.device_status) {
              return `
        <div class="info-card empty-state">
            <h2><i class="fas fa-triangle-exclamation"></i> Дані недоступні</h2>
            <p>Пристрій офлайн або не вдалося отримати інформацію.</p>
        </div>`;
          }

          let content = '';

          if (data.system_info) {
              const sys = data.system_info;
              content += `
        <div class="info-card">
            <h2><i class="fas fa-chart-bar"></i> Системна інформація</h2>
            <div class="info-grid">
                <div class="info-item"><div class="info-label">Модель</div><div class="info-value">${sys.model || 'N/A'}</div></div>
                <div class="info-item"><div class="info-label">Ім'я</div><div class="info-value">${sys.system_name || 'N/A'}</div></div>
                <div class="info-item"><div class="info-label">MAC</div><div class="info-value">${sys.mac_address || 'N/A'}</div></div>
                <div class="info-item"><div class="info-label">Час роботи</div><div class="info-value">${sys.uptime || 'N/A'}</div></div>
            </div>
        </div>`;
          }

          if (data.interfaces && Object.keys(data.interfaces).length > 0) {
              let interfacesHtml = '';

              // Додаємо фільтр портів
              interfacesHtml += `
        <div class="port-filter">
            <button class="filter-btn ${currentFilter === 'all' ? 'active' : ''}" data-filter="all">Усі порти</button>
            <button class="filter-btn ${currentFilter === 'active' ? 'active' : ''}" data-filter="active">Активні</button>
            <button class="filter-btn ${currentFilter === 'inactive' ? 'active' : ''}" data-filter="inactive">Неактивні</button>
        </div>`;

              interfacesHtml += `<div id="interfaces-list">`;
              for (const [id, iface] of Object.entries(data.interfaces)) {
                  const isActive = iface.admin_status === 1 && iface.oper_status === 1;
                  const portClass = isActive ? 'active-port' : 'inactive-port';

                  const speedMbps = iface.speed ? Math.floor(iface.speed / 1000000) : 0;
                  const inMB = ((iface.in_octets || 0) / 1024 / 1024).toFixed(2);
                  const outMB = ((iface.out_octets || 0) / 1024 / 1024).toFixed(2);
                  const adminUp = iface.admin_status === 1;
                  const operUp = iface.oper_status === 1;

                  let errorsHtml = '';
                  if (iface.in_errors || iface.out_errors) {
                      errorsHtml = `<div class="interface-errors"><i class="fas fa-triangle-exclamation"></i> ${iface.in_errors || 0}/${iface.out_errors || 0}</div>`;
                  }

                  interfacesHtml += `
            <div class="interface-row ${portClass}">
                <div class="interface-name"><span class="port-index">${iface.index}</span> ${iface.name}</div>
                <div class="interface-details"><span>${iface.alias || ''}</span> <span class="speed"><i class="fas fa-gauge-high"></i> ${speedMbps} Mbps</span></div>
                <div class="interface-status">
                    <span class="status-tag ${adminUp ? 'status-up' : 'status-down'}">Admin: ${adminUp ? 'UP' : 'DOWN'}</span>
                    <span class="status-tag ${operUp ? 'status-up' : 'status-down'}">Port: ${operUp ? 'UP' : 'DOWN'}</span>
                </div>
                <div class="interface-traffic">
                    <div><i class="fas fa-arrow-down"></i> ${inMB} MB</div>
                    <div><i class="fas fa-arrow-up"></i> ${outMB} MB</div>
                </div>
                ${errorsHtml}
            </div>`;
              }
              interfacesHtml += `</div>`;
              content += `<div class="info-card"><h2><i class="fas fa-plug"></i> Інтерфейси</h2>${interfacesHtml}</div>`;
          }

          return content;
      }

      // Ініціалізація фільтрів при завантаженні сторінки
      document.addEventListener('DOMContentLoaded', function () {
          if (document.querySelector('.port-filter')) {
              setupPortFilters();
          }
      });
  </script>
{% endblock %}